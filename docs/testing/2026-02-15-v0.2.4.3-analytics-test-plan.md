# V0.2.4.3 Analytics Test Plan

## 0. Scope

This document defines test cases for analytics funnel instrumentation in V0.2.4.3.
Priority is end-to-end (E2E) validation, with unit/integration support for deterministic coverage.

## 1. Test Layers

1. Unit tests
- event payload builder
- `device_id` and `session_id` lifecycle helpers
- error code format validator (`{domain}_{type}`)

2. Integration tests
- `POST /api/analytics` validation and persistence
- `analytics_events` write success/failure behavior
- GA4 disabled mode fallback behavior (no Measurement ID)

3. E2E tests (primary)
- full funnel behavior across pages and actions
- QR attribution behavior
- conversion metric computability from emitted events

## 2. E2E Environment Assumptions

1. Playwright runs against local app (`http://127.0.0.1:3000`).
2. Analytics backend endpoint is available (`/api/analytics`).
3. Test database is isolated or cleaned before each suite.
4. GA4 Measurement ID may be absent; backend ingestion must still work.

## 3. E2E Case Matrix

## 3.1 Funnel Mainline

Case ID: `E2E-FUNNEL-001`
- Steps:
  1. open `/scan`
  2. submit scan input
  3. navigate to report page
  4. navigate to poster page
  5. click save/share action
- Assertions:
  - funnel events emitted in expected sequence
  - required fields present (`ts`, `scan_id` where applicable)

## 3.2 Conversion Computability

Case ID: `E2E-FUNNEL-002`
- Steps: run one successful funnel pass
- Assertions:
  - events are sufficient to compute:
    - Scan Start Rate
    - Share Intent Rate
    - Share Success Rate

## 3.3 QR Attribution

Case ID: `E2E-QR-001`
- Steps:
  1. open `/scan/report/{id}?src=poster_qr`
  2. reload same page
- Assertions:
  - `poster_qr_visit` emitted on first-load condition
  - UV dedupe key is `device_id`
  - PV still increments on reload

## 3.4 `device_id` / `session_id`

Case ID: `E2E-ID-001`
- Steps:
  1. open tab A
  2. reload tab A
  3. open tab B
- Assertions:
  - same `device_id` across A and B
  - same `session_id` within A reload
  - different `session_id` between A and B

## 3.5 Download Success Definition

Case ID: `E2E-DOWNLOAD-001`
- Assertions:
  - `poster_download_result.status=success` only when download promise resolves
  - failed download emits `status=error` + valid `error_type`

## 3.6 Share Success Definition

Case ID: `E2E-SHARE-001`
- Assertions:
  - `poster_share_result.status=success` only when `navigator.share()` resolves
  - rejected/unsupported path emits error status and typed error code

## 3.7 GA4 Disabled Mode

Case ID: `E2E-GA4-001`
- Precondition: no `NEXT_PUBLIC_GA4_MEASUREMENT_ID`
- Assertions:
  - no runtime crash
  - backend analytics events still captured

## 3.8 Error and Latency Dimensions

Case ID: `E2E-HEALTH-001`
- Assertions:
  - failed scan/save paths emit `error_code/error_type`
  - scan/poster/save events include positive `duration_ms`

## 4. Query Validation (Post-Run)

Use DB query checks to validate:

1. event counts by name and run id
2. required field non-null rates
3. conversion denominator/numerator consistency
4. QR UV/PV counts by `device_id`

## 5. Non-Goals

1. External platform publish success after system share panel.
2. Cross-device identity merge.
3. Real-time BI dashboard correctness.

## 6. Execution Rule (From This Version On)

For each new analytics/test change:

1. update this test plan (or versioned successor) first
2. then add/modify automated test cases
3. then run and attach results
