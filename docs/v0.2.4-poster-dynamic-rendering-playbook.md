# V0.2.4.0 Poster Dynamic Rendering Playbook

## 1. Goal

Implement and ship a production dynamic poster rendering pipeline based on the approved V0.2.4.0 active spec.

## 2. Workstream Order

1. Normalize renderer inputs and defaults.
2. Implement reusable render module returning PNG buffer.
3. Expose image API endpoint.
4. Wire poster page/report link integration.
5. Add tests and run release gates.

## 3. Implementation Tasks

### Task A - Render Options Contract

1. Define strict option schema for text/ring/color overrides.
2. Parse/validate query params with safe defaults.
3. Reject unsupported keys and malformed values.

### Task B - Renderer Module

1. Move POC logic from `scripts/render-pen-poster-poc.ts` into `lib/poster/`.
2. Keep `.pen` template parsing in one module.
3. Render output as PNG buffer with explicit dimensions.
4. Enforce timeout guard for rendering.

### Task C - API Route

1. Add `GET /api/scan/:id/poster/image`.
2. Fetch report by scan id, derive default poster payload.
3. Merge validated overrides.
4. Return `image/png` with cache headers.

### Task D - Integration

1. Keep `GET /api/scan/:id/poster` unchanged.
2. Update poster page to use generated image endpoint for share/export path.

### Task E - Tests and Verification

1. Unit test: option parser/defaulting.
2. API test: 200/400/404/500 behavior.
3. Render smoke test: valid PNG magic bytes.
4. Build and test gates:
   - `npm test`
   - `npm run build`

## 4. Definition of Done

1. Active spec acceptance criteria all pass.
2. Change plan milestones marked completed.
3. Generated poster output approved on sample inputs (A/B/C grades).
4. Spec and change docs moved to `released/` after shipping.
