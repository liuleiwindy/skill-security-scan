# V0.2 Implementation Playbook (Agent-Executable)

## 1. Objective

Upgrade V0.1 demo scan to real static scan:

`repo URL -> real GitHub file intake -> static analysis -> report -> poster`

Constraints:

- Keep existing API and page routes
- Keep report schema backward compatible
- Add prompt/agent risk detection

## 2. Delivery Scope

1. Real GitHub repository scanning pipeline
2. Mature scanner integration (Semgrep + Gitleaks)
3. Authenticated GitHub API mode (`GITHUB_TOKEN`)
4. npm/npx input scanning
5. Prompt/agent static risk rule coverage
6. Quality hardening: dedupe/performance/false-positive governance

## 3. Target File Plan

```txt
skill-security-scan/
  lib/
    scan/
      github.ts              # new: URL parse + tree/blob fetch + limits/timeout
      rules.ts               # update: add prompt/agent rules
      engine.ts              # update: v0.2 metadata/version support
    store.ts                 # update: use real fetcher instead of mock templates
  app/
    api/scan/route.ts        # update: map typed errors + rate-limit
    scan/page.tsx            # update: remove demo wording
    scan/report/[id]/page.tsx # update: disclaimer wording
  tests/
    github.test.ts           # new
    api.test.ts              # update
    engine.test.ts           # update
    rules.test.ts            # new for prompt/agent rules
```

## 4. Implementation Tasks by Sub-Version

## V0.2.1: Integrate Mature Repo Scanners

## Task A: GitHub Intake Layer

Implement `lib/scan/github.ts`:

1. Parse GitHub URL into:
   - owner
   - repo
   - ref (optional)
   - subPath (optional)
2. Fetch repo default branch when ref missing.
3. Read tree recursively via GitHub API.
4. Filter files by extension/dirs.
5. Fetch blob content into `{ path, content }[]`.
6. Apply bounds:
   - `maxFiles`
   - `maxFileBytes`
   - `timeoutMs`

Done when:

1. Function returns deterministic file list for same repo snapshot.
2. Timeout is enforced with abort.
3. Non-text/oversized files are safely skipped.

## Task B: Pipeline Integration

Update `lib/store.ts`:

1. Replace mock file builder in create flow.
2. Call GitHub intake then `runScan`.
3. Preserve persistence behavior (Postgres/local).

Done when:

1. Report findings come from actual repo file paths.
2. Existing API route contracts remain unchanged.
3. `engineVersion` is upgraded to `v0.2.1`.

## Task C: Authenticated GitHub Mode

1. Support `GITHUB_TOKEN` in GitHub API requests.
2. Keep unauthenticated fallback when token is absent.
3. Ensure typed rate-limit errors remain clear.

Done when:

1. Authenticated requests send Authorization header correctly.
2. Scan success improves under higher API quota.

## Task D: Semgrep + Gitleaks Adapters

Implement:

1. `lib/scan/adapters/semgrep.ts`
2. `lib/scan/adapters/gitleaks.ts`
3. `lib/scan/adapters/normalize.ts`

Requirements:

1. Execute tool command and parse JSON output.
2. Map external result fields into existing `Finding` schema.
3. Merge with internal rules in a stable order.
4. Provide graceful fallback if tool unavailable.

Done when:

1. External findings are visible in report payload in `v0.2.1`.
2. Tool absence does not crash scan API.

## V0.2.1 Test Checklist (Release Blocker)

1. Run unit tests:
   - `tests/github.test.ts`
   - `tests/adapters.test.ts`
2. Run integration/API tests:
   - `tests/api.test.ts`
   - `tests/engine.test.ts`
3. Validate manual E2E on 3 public repos:
   - low-risk baseline repo
   - intentionally risky sample repo
   - medium-size repo
4. Verify report payload:
   - `engineVersion = v0.2.1`
   - merged findings include Semgrep + Gitleaks outputs
   - GitHub token mode works when `GITHUB_TOKEN` is provided
5. Verify routes:
   - `/scan/report/:id` renders correctly
   - `/scan/poster/:id` renders correctly
6. Hard gate:
   - `npm test` must pass before merge/release

## V0.2.2: npm/npx Input Scanning

## Task E: Command Input Intake

1. Add input parser for:
   - GitHub repo URL
   - `npx <pkg[@version]> ...`
   - `npm i <pkg[@version]>`
2. Resolve npm package metadata and tarball URL.
3. Download/extract tarball and run shared scan pipeline.

Done when:

1. Both repo URL and install command can produce scan reports.
2. `scanMeta.source` clearly marks `github_api` vs `npm_registry_tarball`.

## V0.2.3: Prompt Injection & Agent Risk Coverage

## Task F: Prompt/Agent Risk Rules

Update `lib/scan/rules.ts` to add new rule IDs:

1. `PROMPT_INJECTION_OVERRIDE_INSTRUCTIONS`
2. `PROMPT_INJECTION_SYSTEM_PROMPT_EXFIL`
3. `AGENT_EXCESSIVE_AGENCY_SHELL`
4. `AGENT_OUTPUT_TO_EXEC_NO_VALIDATION`

Rule guidance:

1. Keep deterministic regex/heuristic logic.
2. Keep evidence line + snippet + recommendation.
3. Default severity:
   - prompt override/exfil: `high`
   - excessive agency/output-to-exec: `high` or `medium` by confidence

Done when:

1. At least 3 new rules produce findings in fixtures.
2. Existing rule behavior is not regressed.

## V0.2.4: Quality, Dedupe, Performance, False-Positive Governance (Pending Planning)

## Task G: Quality and Dedupe

Implement:

1. Cross-engine dedupe policy (internal rules vs semgrep/gitleaks).
2. Rule severity normalization policy.
3. Evidence prioritization policy when duplicates collide.

Done when:

1. Duplicate findings are significantly reduced on benchmark repos.
2. Findings remain explainable and traceable.

## Task H: Performance and Reliability Baseline

Update API and scan orchestration:

1. Add in-memory rate limit window.
2. Add global scan timeout and per-stage timeout.
3. Map typed API errors:
   - `repo_not_found`
   - `repo_private`
   - `github_rate_limited`
   - `scan_timeout`
   - `repo_fetch_failed`
   - `rate_limited`
4. Keep unknown failures as `internal_error`.

Done when:

1. API returns stable, frontend-readable error JSON.
2. Timeout and rate limit paths are testable.
3. Latency for medium repositories is within target budget.

## Task I: False-Positive Governance + UX Copy

1. Tune noisy rules and set suppression strategy.
2. Update UI copy to remove “simulated/demo” wording.
3. Keep disclaimer as “real static scan, not full audit”.

Done when:

1. UI no longer claims demo simulation.
2. False-positive rate improves on curated fixtures.

## Task J: Tests

Add/update tests:

1. `tests/github.test.ts`
   - URL parsing
   - fetch flow
   - timeout behavior
2. `tests/rules.test.ts`
   - prompt/agent rule matching
3. `tests/adapters.test.ts`
   - semgrep/gitleaks result normalization
   - fallback behavior when tool unavailable
4. `tests/npm-intake.test.ts`
   - install command parsing
   - tarball intake and source tagging
5. `tests/api.test.ts`
   - typed error responses
   - rate limit behavior
6. `tests/engine.test.ts`
   - v0.2 report validation and compatibility
7. `tests/quality.test.ts`
   - dedupe regression checks
   - rule noise/false-positive fixtures

Done when:

1. `npm test` passes.
2. New paths are covered by deterministic fixtures/mocks.

## 5. Rollout Sequence

1. `v0.2.1`: A + B + C
2. `v0.2.2`: E
3. `v0.2.3`: F
4. `v0.2.4`: G + H + I + J

## 6. Definition of Done (V0.2)

1. Real repository static scan is active in production path.
2. Semgrep and Gitleaks findings are merged into normalized report output (`v0.2.1`).
3. GitHub authenticated mode is supported via `GITHUB_TOKEN` (`v0.2.1`).
4. npm/npx command intake is functional (`v0.2.2`).
5. Prompt/agent risk findings appear in report when patterns exist (`v0.2.3`).
6. Dedupe/performance/false-positive goals are achieved (`v0.2.4`).
7. Typed failure responses for timeout and repository access issues are stable.
8. Report/poster flows remain compatible and stable.
9. All tests pass.
