# V0.2.2 Implementation Playbook (npm/npx Intake)

## 1. Goal

Enable package-command-first scanning while preserving all V0.2.1 contracts.

## 2. Target Files

1. `/Users/lei_liu/Documents/Code/skill-store/skill-security-scan/lib/validation.ts`
2. `/Users/lei_liu/Documents/Code/skill-store/skill-security-scan/lib/store.ts`
3. `/Users/lei_liu/Documents/Code/skill-store/skill-security-scan/lib/scan/npm.ts` (new)
4. `/Users/lei_liu/Documents/Code/skill-store/skill-security-scan/lib/scan/engine.ts`
5. `/Users/lei_liu/Documents/Code/skill-store/skill-security-scan/app/api/scan/route.ts`
6. `/Users/lei_liu/Documents/Code/skill-store/skill-security-scan/app/scan/page.tsx`
7. `/Users/lei_liu/Documents/Code/skill-store/skill-security-scan/tests/npm.test.ts` (new)
8. `/Users/lei_liu/Documents/Code/skill-store/skill-security-scan/tests/api.test.ts`

## 3. Task Breakdown

### Task A: Input Classification

1. Add classifier for:
   - GitHub URL
   - npm install command
2. Keep backward compatibility with current `repoUrl` field.
3. Return typed validation errors for malformed npm command input.

Done when:

1. Parser unit tests cover valid/invalid command variants.

### Task B: npm Intake Adapter

1. Add npm registry metadata resolver.
2. Add tarball downloader with timeout and byte limits.
3. Add safe extraction and file filtering into `MockFile[]`.
4. Apply fixed limits for V0.2.2:
   - tarball `<=10MB`
   - extraction timeout `25s`
   - scanned files `<=300`
   - single file `<=300KB`

Done when:

1. Known npm package can be fetched and scanned in local validation.
2. Oversize tarball path returns `npm_tarball_too_large`.
3. Extracted file count oversize returns `npm_extracted_files_exceeded`.
4. Extracted per-file oversize returns `npm_extracted_file_too_large`.

### Task C: Pipeline Wiring

1. In store pipeline, route intake by source type.
2. Reuse existing internal + Semgrep + Gitleaks merge flow.
3. Set `engineVersion = v0.2.2`.
4. Fill `scanMeta.source = npm_registry` and optional package metadata.
5. Do not persist tarball URL in report metadata.

Done when:

1. `POST /api/scan` returns scan ID for npm command input.
2. `GET /api/scan/:id` payload remains schema-compatible.

### Task D: UX Copy and Error Mapping

1. Update `/scan` input examples to include npm/npx commands.
2. Map npm errors to stable typed API response format.

Done when:

1. User can understand both input modes from entry page copy.
2. API returns non-generic errors for known npm failure types.

### Task E: Tests and Validation

1. Add `tests/npm.test.ts` for parser and intake limits.
2. Extend `tests/api.test.ts` for npm success/error paths.
3. Run full `npm test` regression.

Done when:

1. Full test suite passes.
2. Both GitHub and npm paths pass smoke tests.
3. npm limit error paths are asserted:
   - `npm_tarball_too_large`
   - `npm_extracted_files_exceeded`
   - `npm_extracted_file_too_large`

## 4. Release Checklist

1. `engineVersion` is `v0.2.2`.
2. `scanMeta.source` differentiates `github_api` vs `npm_registry`.
3. npm typed errors are contract-tested.
4. Report/poster rendering remains stable.
